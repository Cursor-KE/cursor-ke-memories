name: Keep Supabase alive

on:
  schedule:
    # Run every Sunday at midnight UTC to keep Supabase instance active
    - cron: "0 0 * * 0"
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '.github/workflows/supabase-keepalive.yml'

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set default Supabase URL if secret not set
        run: |
          if [ -z "${SUPABASE_URL}" ]; then
            echo "SUPABASE_URL=https://wlqtxgvsbxpttdzwpwbm.supabase.co" >> "$GITHUB_ENV"
            echo "Using default Supabase URL"
          else
            echo "SUPABASE_URL=${SUPABASE_URL}" >> "$GITHUB_ENV"
          fi
      
      - name: Normalize base URL
        run: |
          set -euo pipefail
          BASE="${SUPABASE_URL%/}"
          # Strip common subpaths if user pasted REST or AUTH URLs
          BASE="${BASE%%/rest/v1*}"
          BASE="${BASE%%/auth/v1*}"
          echo "SUPABASE_ORIGIN=${BASE}" >> "$GITHUB_ENV"
          echo "Using origin: ${BASE}"
      
      - name: Ping Auth health endpoint
        continue-on-error: true
        run: |
          echo "Pinging Auth endpoint..."
          CODE="$(curl -sS -m 15 -o /dev/null -w "%{http_code}" "${SUPABASE_ORIGIN}/auth/v1/health" || echo 000)"
          echo "Auth health HTTP ${CODE}"
          if [ "$CODE" = "200" ] || [ "$CODE" = "204" ]; then
            echo "âœ… Auth endpoint is healthy"
          else
            echo "âš ï¸ Auth endpoint returned ${CODE}"
          fi
      
      - name: Ping PostgREST endpoint
        continue-on-error: true
        run: |
          echo "Pinging PostgREST endpoint..."
          CODE="$(curl -sS -I -m 15 -o /dev/null -w "%{http_code}" "${SUPABASE_ORIGIN}/rest/v1/" || echo 000)"
          echo "REST root HTTP ${CODE}"
          if [ "$CODE" = "200" ] || [ "$CODE" = "401" ]; then
            echo "âœ… REST endpoint is responding"
          else
            echo "âš ï¸ REST endpoint returned ${CODE}"
          fi
      
      - name: Query database with API key
        if: ${{ env.SUPABASE_ANON_KEY != '' }}
        continue-on-error: true
        run: |
          echo "Querying database with API key..."
          CODE="$(curl -sS -m 15 -o /dev/null -w "%{http_code}" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            "${SUPABASE_ORIGIN}/rest/v1/memories?select=id&limit=1" || echo 000)"
          echo "Database query HTTP ${CODE}"
          if [ "$CODE" = "200" ] || [ "$CODE" = "404" ]; then
            echo "âœ… Database is accessible"
          else
            echo "âš ï¸ Database query returned ${CODE}"
          fi
      
      - name: Summary
        run: |
          echo "ðŸŽ¯ Keepalive ping completed"
          echo "This workflow runs every Sunday at midnight UTC to prevent Supabase free tier from pausing"
      
      - name: Keep workflow active
        run: |
          echo "Workflow last run: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "This prevents GitHub from auto-disabling scheduled workflows after 60 days of inactivity"
      
      - name: Create activity to prevent workflow disable
        if: github.event_name == 'schedule'
        run: |
          # Create a simple activity log file
          mkdir -p .github/keepalive
          echo "Last keepalive run: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" > .github/keepalive/last-run.txt
          
          # Only commit if there are changes
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/keepalive/last-run.txt || true
          git diff --staged --quiet || git commit -m "chore: keepalive workflow run [skip ci]"
          git push || echo "No changes to push or push failed"
